# ‚öôÔ∏è TaskSystem ‚Äî –í–∏—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–Ω–∞ –°–∏—Å—Ç–µ–º–∞ –∑–∞ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ –ò–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –ó–∞–¥–∞—á–∏

## üîç –ö–∞–∫–≤–æ –µ —Ç–æ–≤–∞?

`TaskSystem` –µ –º–æ–¥—É–ª–Ω–∞, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∑–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –∑–∞–¥–∞—á–∏ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∏. –ü—Ä–æ–µ–∫—Ç–∏—Ä–∞–Ω–∞ –µ –∑–∞ **–º–∞–∫—Å–∏–º–∞–ª–Ω–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç** –≤ –º—É–ª—Ç–∏–ø—Ä–æ—Ü–µ—Å–æ—Ä–Ω–∏ –∏ –º–Ω–æ–≥–æ–Ω–∏—à–∫–æ–≤–∏ —Å—Ä–µ–¥–∏. –ü–æ–¥–¥—ä—Ä–∂–∞:

- üìå –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∏ –Ω–∞ –∑–∞–¥–∞—á–∏—Ç–µ
- ‚ö° –°–ø–æ–¥–µ–ª–µ–Ω–æ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ (Shared Execution) ‚Äî –≤—Å–∏—á–∫–∏ –Ω–∏—à–∫–∏ —Ä–∞–±–æ—Ç—è—Ç –ø–æ –µ–¥–Ω–∞ –∑–∞–¥–∞—á–∞
- üöÄ Lock-free –º–µ—Ö–∞–Ω–∏–∑–º–∏ –∑–∞ –æ–ø–∞—à–∫–∏
- üß† Callback-–∏ –ø—Ä–∏ –ø—Ä–∏–∫–ª—é—á–≤–∞–Ω–µ –Ω–∞ –∑–∞–¥–∞—á–∏
- üßµ –õ–µ–∫–æ –ø–ª–∞–Ω–∏—Ä–∞–Ω–µ —Å—ä—Å "step budget" –∏ round-robin –∑–∞ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞

---

## üß± –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –ö–∞–∫ —Ä–∞–±–æ—Ç–∏?

### –û—Å–Ω–æ–≤–Ω–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏:

- **Task**: –æ–ø–∏—Å–≤–∞ –µ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏
- **Executor**: –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –∑–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ "—Å—Ç—ä–ø–∫–∞" –æ—Ç –∑–∞–¥–∞—á–∞—Ç–∞
- **TaskSystemExecutor**: —É–ø—Ä–∞–≤–ª—è–≤–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∏, –Ω–∏—à–∫–∏ –∏ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
- **CBQueue**: –æ–ø–∞—à–∫–∞ –∑–∞ callback-–∏ –ø—Ä–∏ –ø—Ä–∏–∫–ª—é—á–≤–∞–Ω–µ
- **Worker Threads**: –≤—Å–∏—á–∫–∏ —Ä–∞–±–æ—Ç–Ω–∏—Ü–∏ –º–æ–≥–∞—Ç –¥–∞ –∏–∑–ø—ä–ª–Ω—è–≤–∞—Ç —Å—Ç—ä–ø–∫–∏ –æ—Ç –µ–¥–Ω–∞ –∏ —Å—ä—â–∞ –∑–∞–¥–∞—á–∞

### üß† –ö–∞–∫–≤–æ —Ä–µ—à–∞–≤–∞ —Ç–∞–∑–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞?

- ‚ùå –ò–∑–±—è–≥–≤–∞ –±–ª–æ–∫–∏—Ä–∞—â–∏ lock-–æ–≤–µ
- ‚úÖ –ü–æ–¥–¥—ä—Ä–∂–∞ –º–∞–∫—Å–∏–º–∞–ª–µ–Ω CPU throughput
- ‚úÖ –ü–æ–¥–¥—ä—Ä–∂–∞ –ª–æ–∫–∞–ª–Ω–æ—Å—Ç –≤ –∫–µ—à–∞
- ‚úÖ –°–ø–æ–¥–µ–ª–µ–Ω–æ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ ‚Üí –≤—Å–∏—á–∫–∏ –Ω–∏—à–∫–∏ —Å—ä–≤–º–µ—Å—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–≤–∞—Ç –µ–¥–Ω–∞ –∑–∞–¥–∞—á–∞
- üåÄ Round-robin balancing ‚Üí –∏–∑–±—è–≥–≤–∞–º–µ starving

---

## üßÆ –ü–æ—Ç–æ–∫ –Ω–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ (Execution Flow)

1. –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –¥–µ—Ñ–∏–Ω–∏—Ä–∞ –∑–∞–¥–∞—á–∞ –∏ `Executor`, –∫–æ–π—Ç–æ –∑–Ω–∞–µ –∫–∞–∫ –¥–∞ —è –∏–∑–ø—ä–ª–Ω–∏.
2. –ó–∞–¥–∞—á–∞—Ç–∞ —Å–µ –ø–æ–¥–∞–≤–∞ –Ω–∞ `ScheduleTask()`.
3. –°—ä–∑–¥–∞–≤–∞ —Å–µ `TaskControl` –∏ —Å–µ –ø–æ—Å—Ç–∞–≤—è –≤ –ø–æ–¥—Ö–æ–¥—è—â–∞—Ç–∞ `prioGroup`.
4. –†–∞–±–æ—Ç–Ω–∏—Ç–µ –Ω–∏—à–∫–∏ –æ–±—Ö–æ–∂–¥–∞—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∏—Ç–µ –æ—Ç –Ω–∞–π-–≤–∏—Å–æ–∫ –Ω–∞–¥–æ–ª—É –∏ —Å–∏ "–∫—Ä–∞–¥–∞—Ç" —Å—Ç—ä–ø–∫–∏ –æ—Ç –∑–∞–¥–∞—á–∏.
5. –ü—Ä–∏ –ø—Ä–∏–∫–ª—é—á–≤–∞–Ω–µ —Å–µ –∏–∑–ø—ä–ª–Ω—è–≤–∞—Ç callback-–∏ —á—Ä–µ–∑ `CBQueue`.

---

## üîê –ó–∞—â–∏—Ç–∞ –æ—Ç –ß–µ—Å—Ç–æ –°—Ä–µ—â–∞–Ω–∏ –ü—Ä–æ–±–ª–µ–º–∏

### ‚úÖ False Sharing –∏ Cache Line Padding

- –í—Å–∏—á–∫–∏ `TaskControl` —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ —Å–∞ `alignas(64)`, –∫–æ–µ—Ç–æ:
  - –ì–∞—Ä–∞–Ω—Ç–∏—Ä–∞, —á–µ —á–µ—Å—Ç–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–∞–Ω–∏—Ç–µ –ø–æ–ª–µ—Ç–∞ –∫–∞—Ç–æ `budget` –∏–ª–∏ `state` –Ω–µ —Å–ø–æ–¥–µ–ª—è—Ç –∫–µ—à –ª–∏–Ω–∏—è —Å –¥—Ä—É–≥–∏ –æ–±–µ–∫—Ç–∏
  - –ò–∑–±—è–≥–≤–∞ **false sharing**, –∫–æ–µ—Ç–æ –≤–æ–¥–∏ –¥–æ –∫–µ—à invalidation –∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è

### ‚úÖ Cache-Friendly –¥–æ—Å—Ç—ä–ø

- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ç–µ —Å–∞ –∫–æ–º–ø–∞–∫—Ç–µ–Ω —Ç–∏–ø (`std::array`, `std::vector`) –∏ –¥–æ—Å—Ç—ä–ø—ä—Ç –¥–æ –∑–∞–¥–∞—á–∏ –µ –ª–æ–∫–∞–ª–µ–Ω
- –ò–∑–ø–æ–ª–∑–≤–∞–º–µ `std::atomic<uint32_t> budget` –∏ –¥—Ä—É–≥–∏ –∞—Ç–æ–º–∏—Ü–∏, –∫–æ–∏—Ç–æ —Å–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–∞—Ç –ø—Ä–µ–¥–∏–º–Ω–æ –æ—Ç –µ–¥–Ω–∞ –Ω–∏—à–∫–∞ ‚Üí –∏–∑–±—è–≥–≤–∞–º–µ cache line ping-pong

### ‚úÖ Lock-Free –∏ Race-Safe

- CBQueue e **lock-free ring buffer**
- –ü–∞—Ä–∞–ª–µ–ª–µ–Ω –¥–æ—Å—Ç—ä–ø –¥–æ `prioGroups` —á—Ä–µ–∑ `shared_mutex` –∑–∞ —á–µ—Ç–µ–Ω–µ
- –ò–∑–ø–æ–ª–∑–≤–∞–º–µ `std::memory_order_relaxed` —Å–∞–º–æ –∫–æ–≥–∞—Ç–æ –Ω—è–º–∞ –Ω—É–∂–¥–∞ –æ—Ç —Å—Ç—Ä–æ–≥–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–Ω–æ—Å—Ç ‚Äî –Ω–∞–ø—Ä. –ø—Ä–∏ `activeMask`

### ‚úÖ –ò–∑–±—è–≥–≤–∞–Ω–µ –Ω–∞ Deadlocks

- –ò–∑–ø–æ–ª–∑–≤–∞–º–µ `condition_variable_any`, –Ω–æ –Ω–∏–∫–æ–≥–∞ –Ω–µ –¥—ä—Ä–∂–∏–º –≤—ä–Ω—à–µ–Ω `mutex` –¥–æ–∫–∞—Ç–æ —á–∞–∫–∞–º–µ
- Callback-–∏—Ç–µ —Å–µ –∏–∑–ø—ä–ª–Ω—è–≤–∞—Ç –∏–∑–≤—ä–Ω –∫—Ä–∏—Ç–∏—á–µ–Ω —É—á–∞—Å—Ç—ä–∫

### ‚úÖ –ò–∑–±—è–≥–≤–∞–Ω–µ –Ω–∞ Spinlock –±–ª–æ–∫–∏—Ä–∞–Ω–µ

- –ù—è–º–∞ –∞–∫—Ç–∏–≤–Ω–æ —á–∞–∫–∞–Ω–µ —Å `while(lock)`; –Ω–∞–≤—Å—è–∫—ä–¥–µ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ `std::this_thread::yield()` –∑–∞ –ø–ª–∞–≤–Ω–æ –∑–∞—Å–ø–∏–≤–∞–Ω–µ

### ‚úÖ Spurious Wakeups ‚Äî –∏ –∑–∞—â–æ –≥–∏ –æ—Ç—á–∏—Ç–∞–º–µ

- –ü—Ä–∏ `WaitForTask()` –∏–∑–ø–æ–ª–∑–≤–∞–º–µ:
  ```cpp
  waiter_cv.wait(lock, [&] { return state == Finished; }); , –∑–∞ –¥–∞ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–∞–º–µ, —á–µ —â–µ —Å–µ —Å—ä–±—É–¥–∏–º —Å–∞–º–æ –ø—Ä–∏ —Ä–µ–∞–ª–Ω–æ –ø—Ä–∏–∫–ª—é—á–≤–∞–Ω–µ ‚Äî –∏–∑–±—è–≥–≤–∞–º–µ —Ñ–∞–ª—à–∏–≤–æ —Å—ä–±—É–∂–¥–∞–Ω–µ

---

## üö´ –ó–∞—â–æ –Ω–µ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ:

### ‚ùå NUMA-aware Memory Placement

- –ó–∞—â–æ—Ç–æ:
    - –í—Å–∏—á–∫–∏ –Ω–∏—à–∫–∏ —Å–ø–æ–¥–µ–ª—è—Ç —Ä–∞–±–æ—Ç–∞ ‚Üí `context switch` –º–µ–∂–¥—É `NUMA` –Ω–æ–¥–æ–≤–µ –±–∏ –¥–æ–≤–µ–ª –¥–æ:
       - –ø–æ–≤–µ—á–µ latency
       - remote memory access penalty
    - `NUMA` –±–∏ –∏–º–∞–ª —Å–º–∏—Å—ä–ª —Å–∞–º–æ –∞–∫–æ –∑–∞–∫—Ä–µ–ø–∏–º –∑–∞–¥–∞—á–∞—Ç–∞ –∫—ä–º –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω –Ω–æ–¥ + —Ä–∞–∑–ø—Ä–µ–¥–µ–ª–∏–º –ø–∞–º–µ—Ç—Ç–∞ –ª–æ–∫–∞–ª–Ω–æ ‚Üí —Ç–æ–≤–∞ –Ω–µ –µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª–Ω–æ

### ‚ùå SIMD / Prefetching

- –ö–æ–º–ø–∞–∏–ª–∞—Ç–æ—Ä—ä—Ç —Å–∞–º –ø—Ä–∏–ª–∞–≥–∞ `auto-vectorization` –∞–∫–æ `ExecuteStep()` –µ –¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ –ª–∏–Ω–µ–π–Ω–∞
- Prefetching –Ω–µ –µ –Ω—É–∂–Ω–æ ‚Äî `ExecuteStep()` –µ user-defined, –Ω—è–º–∞ –ø–æ—Å—Ç–æ—è–Ω–µ–Ω —à–∞–±–ª–æ–Ω –∑–∞ –¥–∞–Ω–Ω–∏

## üìñ –û–±—è—Å–Ω–µ–Ω–∏–µ –Ω–∞ –û—Å–Ω–æ–≤–Ω–∏ –ú–µ—Ç–æ–¥–∏

### `TaskID ScheduleTask(std::unique_ptr<Task> t, int pr);`

- –í–∑–µ–º–∞ Executor –ø–æ –∏–º–µ, —Å—ä–∑–¥–∞–≤–∞ `TaskControl`, –¥–æ–±–∞–≤—è –≤ —Å—ä–æ—Ç–≤–µ—Ç–Ω–∞—Ç–∞ –≥—Ä—É–ø–∞.
- –ò–∑–ø–æ–ª–∑–≤–∞ `reinterpret_cast<uintptr_t>(tc)` –∑–∞ —É–Ω–∏–∫–∞–ª–Ω–æ ID ‚Äî –¥–∏—Ä–µ–∫—Ç–µ–Ω pointer cast.

### `void push_task(TaskControl* tc);`

- –î–æ–±–∞–≤—è –∑–∞–¥–∞—á–∞—Ç–∞ –≤ `prioGroups`
- –ò–∑–ø–æ–ª–∑–≤–∞ `activeMask.fetch_or(...)` —Å `memory_order_relaxed` ‚Üí –Ω—è–º–∞ –Ω—É–∂–¥–∞ –æ—Ç –ø—ä–ª–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è, —Å–∞–º–æ –º–∞—Ä–∫–∏—Ä–∞–Ω–µ

### `pop_highest_priority_task / steal_from_group`

- –ò–∑–≤–ª–∏—á–∞—Ç –∑–∞–¥–∞—á–∞ —Å –Ω–∞–π-–≤–∏—Å–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç –≥—Ä—É–ø–∞, –∏–∑–ø–æ–ª–∑–≤–∞–π–∫–∏ round-robin –±–∞–ª–∞–Ω—Å–µ—Ä (`rrIndex`)
- –ò–∑–ø–æ–ª–∑–≤–∞ `shared_lock` –∑–∞ –ø–∞—Ä–∞–ª–µ–ª–µ–Ω –¥–æ—Å—Ç—ä–ø –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ –Ω–∏—à–∫–∏

###  `ExecuteStep` (–≤ Executor-–∏)

`int rem = remaining.fetch_sub(1000);`
`if (rem <= 0) return ES_Stop;`
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞ –ø–∞—Ä–∞–ª–µ–ª–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –∑–∞–¥–∞—á–∞ –æ—Ç –º–Ω–æ–≥–æ –Ω–∏—à–∫–∏

### `void finalize(TaskControl* tc);`

- –ú–∞—Ä–∫–∏—Ä–∞ –∑–∞–¥–∞—á–∞—Ç–∞ –∫–∞—Ç–æ –∑–∞–≤—ä—Ä—à–µ–Ω–∞, –∏–∑–≤–∞–∂–¥–∞ –æ—Ç prioGroup, –∏–∑–ø—ä–ª–Ω—è–≤–∞ callback-–∏
- –ü—Ä–µ–º–∞—Ö–≤–∞ TaskControl –æ—Ç –≤–µ–∫—Ç–æ—Ä–∞ –∏ –∞–∫–æ –Ω—è–º–∞ –ø–æ–≤–µ—á–µ –∑–∞–¥–∞—á–∏ ‚Üí –∑–∞–Ω—É–ª—è–≤–∞ –±–∏—Ç–∞ –≤ activeMask

### CBQueue (callback queue)

`void push(FnPtr f);` // lock-free
`FnPtr pop();`        // lock-free
- Lock-free ring buffer
- –ò–∑–ø–æ–ª–∑–≤–∞ `head` –∏ `tail` —Å –∞—Ç–æ–º–∏—á–Ω–∏ –∏–Ω–¥–µ–∫—Å–∏, `memory_order_acquire/release`

## üß™ –ü—Ä–∏–º–µ—Ä–Ω–∏ –ó–∞–¥–∞—á–∏

- `Raytracer`: —Å—Ç—ä–ø–∫–æ–≤–æ –Ω–∞–º–∞–ª—è–≤–∞ –±—Ä–æ—è—á
- `Printer`: –ø—Ä–∏–Ω—Ç–∏—Ä–∞ –ø–æ—Ä–µ–¥–∏—Ü–∞ —á–∏—Å–ª–∞
- `Cruncher`: —Ä–∞–±–æ—Ç–∏ —Å –≥–æ–ª–µ–º–∏ —á–∏—Å–ª–∞, –∏–∑–ø–æ–ª–∑–≤–∞

## üìå –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

- –ü—Ä–æ–µ–∫—Ç—ä—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–≤–∞ –¥–æ–±—Ä–µ –º–∞—â–∞–±–∏—Ä—É–µ–º–∞, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞ –∏ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∑–∞       –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –∑–∞–¥–∞—á–∏, –±–∞–∑–∏—Ä–∞–Ω–∞ –Ω–∞ –¥–æ–±—Ä–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏ –æ—Ç –æ–±–ª–∞—Å—Ç—Ç–∞ –Ω–∞ —Å—ä–≤—Ä–µ–º–µ–Ω–Ω–∏—Ç–µ –º–Ω–æ–≥–æ–Ω–Ω–∏—à–∫–æ–≤–∏ —Å—Ä–µ–¥–∏. –ü–æ–¥—Ö–æ–¥—è—â–∞ –µ –∑–∞ —Å–∏—Å—Ç–µ–º–∏ —Å –º–Ω–æ–≥–æ —è–¥—Ä–∞, –≤–∫–ª—é—á–∏—Ç–µ–ª–Ω–æ HPC —Å–∏—Å—Ç–µ–º–∏.

## ‚öôÔ∏è –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞ –ö–æ–º–ø–∏–ª–∞—Ü–∏—è –Ω–∞ macOS (Clang)

- clang++ -std=c++20 -O2 -pthread single_file_demo.cpp -o task_system
- ./task_system


